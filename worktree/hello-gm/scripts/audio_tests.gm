
// audio_tests.gm

Log("audio_tests.gm: Initializing...");

global MakeAudioTest = function()
{
    local Main = {
    };

    Main.Init = function()
    {
        .update_id = this:thread(.Update);

		.cam2d = Cam2d();
		.cam2d.InitScreenSpaceSize( Window.GetDimen() );
		.cam2d.SetNearFar(v2(-1000.0f, 1000.0f ));

        .audio = GMAudioStream("audio", g_ip, g_port);
        .sine_frequency = 5;

        if ( !g_norobot )
        {
            .audio.SetActive(true);
        }
        else
        {
            // TODO: fix update order so we don't need to do this first
            .audio.AddSineWave(0);
        }
    };

    Main.Release = function()
    {
        threadKill(.update_id);
    };

    Main.ClearScreen = function()
    {
		Gfx.ClearColor( Gfx.BLUE * v3(0.1f), 1.0f );
		Gfx.ClearDepth(1.0f);
		Gfx.Clear( Gfx.COLOR_BUFFER_BIT | Gfx.DEPTH_BUFFER_BIT );
    };

    Main.Gui = function()
    {
        Gui.Begin("Audio", g_core.screenDimen.x.Int() - 310, g_core.screenDimen.y.Int() - 5);

        .sine_frequency = Gui.SliderInt("Sine Frequency", .sine_frequency, 1, 64);

        Gui.End();
    };

    Main.DrawWaveform = function()
    {
		Gfx.Viewport( v2(0.0f), g_core.screenDimen );
		Gfx.BeginDefaultShader();

        .cam2d.Begin();

		Gfx.Color(Gfx.WHITE, 1.0f);

        .audio.ClearSineWave(.sine_frequency); // DEBUG 
        .audio.AddSineWave(.sine_frequency); // DEBUG 
        .audio.DrawWaveform(0, Gfx.BLUE, 1.0f);

        .audio.CalcBeatDFT(0);
        .audio.DrawBeatWaveform(0, Gfx.RED, 0.5f);

        .cam2d.End();

		Gfx.EndDefaultShader();
		Gfx.Viewport( v2(0), g_core.screenDimen );
    };

    Main.DrawDualVideo = function()
    {
		Gfx.Viewport( v2(0.0f), g_core.screenDimen );
		Gfx.BeginDefaultShader();

        .cam2d.Begin();

		Gfx.Color(Gfx.WHITE, 1.0f);

        local vscale = 2.0f;
		local vsize = v2(160.0f, 120.0f) * vscale;
		local vpos = g_core.screenDimen * v2(0.2f, 0.2f) - vsize * 0.5f;

        local v0 = .video0.GetTexture();
        local v1 = .video1.GetTexture();

        v0.Bind(0);
		Gfx.DrawRectTexCoords( vpos, vsize );
        v0.Unbind();

        vpos = vpos + v2(vsize.x + 32.0f, 0.0f);

        v1.Bind(0);
		Gfx.DrawRectTexCoords( vpos, vsize );
        v1.Unbind();

        vpos = vpos + v2(vsize.x * -0.5f - 16.0f, vsize.y + 32.0f);

        .videodisparity.Bind(0);
		Gfx.DrawRectTexCoords( vpos, vsize );
        .videodisparity.Unbind();

        .cam2d.End();

		Gfx.EndDefaultShader();
		Gfx.Viewport( v2(0), g_core.screenDimen );
    };

    Main.Update = function()
    {
        while (true)
        {
    		RegisterDraw( DrawLayers.Clear, .ClearScreen, this );
    		RegisterDraw( DrawLayers.Scene, .DrawWaveform, this );
    		RegisterGui( .Gui, this );			

            if (g_norobot)
            {
                //.audio.ClearSineWave(.sine_frequency);
                //.audio.AddSineWave(.sine_frequency);
            }
            else
            {
                .audio.Update();
            }

            yield();
        }
    };

    Main.Init();
    return Main;
};
